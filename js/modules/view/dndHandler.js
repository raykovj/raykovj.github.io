define("modules/view/dndHandler",["modules/view/dndTracker","modules/geometry/point","modules/geometry/rectangle","modules/draw/draw","modules/graph/graphConstants","modules/settings/config","modules/diagram/diagramUtils","modules/view/dndUtils","modules/flow/flowUtils","modules/dialogs/messageDialog"],function(e,t,o,r,a,n,g,l,i,d){function s(o){function d(){z.drawAcceptingLocations(),J.paintDiagram(),s()}function s(){var e=Z.getContext("2d");if($.getDragMode()===a.dragMode().MARKUP_PORT||$.getDragMode()===a.dragMode().REF_PORT)e.lineWidth=2,e.setLineDash([0,0]),e.strokeStyle=a.colors().DND_LINE,e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(V.x,V.y),e.stroke();else if($.getDragMode()===a.dragMode().LINK_PORT&&I&&V){var t=n.getLinkStyle()===a.linkStyle().DOUBLE_ARROW?I.getAttachmentPoint():I.getConnectionPoint();e.lineWidth=2,I.getType()===a.portType().LINK_REF?e.setLineDash([4,2]):e.setLineDash([0,0]),e.strokeStyle=a.colors().DND_LINE,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(V.x,V.y),e.stroke()}}function p(e){return!!z.getAcceptingCellAtPoint(e)||(u(e,h),W>-1||q>-1)}function T(e){var t=Z.getContext("2d");r.paintRectangle(t,e,a.colors().EMPTY_CORRIDOR,a.colors().GRID,1)}function L(e,t){var o=Z.getContext("2d");r.paintRectangle(o,e,t,a.colors().GRID,1)}function f(e,t){for(var o=Z.getContext("2d"),n=0;n<e.length;n++)r.paintRectangle(o,e[n],t,a.colors().GRID,1)}function v(e){var t=J.getModelHandler().getFlowNodes();return l.getNodeAtPoint(t,e)}function M(e){var t=J.getModelHandler().getFlowNodes();return l.getPortAtPoint(t,e)}function c(e){var t=J.getModelHandler().getFlowLinks();return l.getLinkAtPoint(t,e)}function y(e){var t=c(e);return t?t.getSegmentAtPoint(e):void 0}function P(e){for(var t=J.getFlowDiagram().getFlowLinks(),o=0;o<t.length;o++)t[o].hasSegmentShifts()||t[o].highlightOnMouseMove(e)}function w(){for(var e=[],t=Q.getEmptyCells(),o=0;o<t.length;o++)N(t[o].getLevelNumber(),t[o].getLaneNumber())&&e.push(t[o]);return e}function D(){for(var e=[],t=Q.getEmptyCells(),o=Q.getLevels().length-1,r=Q.getLanes().length-1,a=n.hasSideSwimLanes()&&n.hasStartEndLevels(),g=0;g<t.length;g++){var l=t[g].getLevelNumber(),i=t[g].getLaneNumber();a&&(0===l&&0===i||0===l&&i===r||l===o&&0===i||l===o&&i===r)||e.push(t[g])}return e}function N(e,t){var o=Q.getLevels().length-1,r=Q.getLanes().length-1;return m&&m.getFlowType()===a.flowType().START||h===a.flowType().START?0===e&&n.hasStartEndLevels()&&(!n.hasSideSwimLanes()||t>0&&t<r):m&&m.getFlowType()===a.flowType().END||h===a.flowType().END?e===o&&n.hasStartEndLevels()&&(!n.hasSideSwimLanes()||t>0&&t<r):m&&m.getFlowType()===a.flowType().PROCESS||h===a.flowType().PROCESS||m&&m.getFlowType()===a.flowType().IN_OUT||h===a.flowType().IN_OUT||m&&m.getFlowType()===a.flowType().DECISION||h===a.flowType().DECISION?n.hasStartEndLevels()?e>0&&e<o&&(!n.hasSideSwimLanes()||t>0&&t<r):!n.hasSideSwimLanes()||t>0&&t<r:m&&m.getFlowType()===a.flowType().LEFT_TOP||h===a.flowType().LEFT_TOP?n.hasSideSwimLanes()&&0==t&&(!n.hasStartEndLevels()||e>0&&e<o):!!(m&&m.getFlowType()===a.flowType().RIGHT_BOTTOM||h===a.flowType().RIGHT_BOTTOM)&&(n.hasSideSwimLanes()&&t==r&&(!n.hasStartEndLevels()||e>0&&e<o))}function O(e){var t=Q.getLevelPipes(),o=Q.getLanePipes(),r=i.getMinLevelNumber(),a=i.getMaxLevelNumber(Q),n=i.getMinLaneNumber(),g=i.getMaxLaneNumber(Q);X=i.getRectangleAtPoint(e,t);var l=X?X.getOrder():-1;(l<r||l>a+1)&&(X=void 0),j=i.getRectangleAtPoint(e,o);var d=j?j.getOrder():-1;(d<n||d>g+1)&&(j=void 0)}function u(e,t){var o=Q.getLevels(),r=Q.getLevelPipes(),g=Q.getLanes(),l=Q.getLanePipes();X=i.getRectangleAtPoint(e,r),W=X?X.getOrder():-1,j=i.getRectangleAtPoint(e,l),q=j?j.getOrder():-1;var d=i.getRectangleAtPoint(e,o),s=d?d.getOrder():-1,p=i.getRectangleAtPoint(e,g),T=p?p.getOrder():-1,L=!1,f=!1,v=i.getMaxLevelNumber(Q),M=i.getMaxLaneNumber(Q),c=i.getMinLevelNumber(),y=i.getMinLaneNumber();t===a.flowType().START?(L=!0,n.hasStartEndLevels()?0!=s?f=!0:n.hasSideSwimLanes()&&(q<y||q>M+1)&&(f=!0):f=!0):t===a.flowType().END?(L=!0,n.hasStartEndLevels()?s!=v+1?f=!0:n.hasSideSwimLanes()&&(q<y||q>M+1)&&(f=!0):f=!0):t===a.flowType().PROCESS||t===a.flowType().DECISION||t===a.flowType().IN_OUT?(n.hasStartEndLevels()&&(0==W||W>v+1)&&(L=!0,f=!0),n.hasSideSwimLanes()&&(0==q||q>M+1)&&(L=!0,f=!0)):t===a.flowType().LEFT_TOP?(f=!0,n.hasSideSwimLanes()?0!=T?L=!0:n.hasStartEndLevels()&&(W<c||W>v+1)&&(L=!0):L=!0):t===a.flowType().RIGHT_BOTTOM&&(f=!0,n.hasSideSwimLanes()?T!=M+1?L=!0:n.hasStartEndLevels()&&(W<c||W>v+1)&&(L=!0):L=!0),L&&(X=void 0,W=-1),f&&(j=void 0,q=-1)}function S(e,t){var o=n.hasStartEndLevels()?1:0,r=n.hasStartEndLevels()?Q.getLevels().length-2:Q.getLevels().length-1,g=-1;if(t==a.flowType().START)g=0;else if(t==a.flowType().END)g=Q.getLevels().length-1;else if(t==a.flowType().PROCESS||t==a.flowType().DECISION||t==a.flowType().IN_OUT)if(W>-1)g=W;else{var l=i.getLevelIndexAtPoint(e,Q.getLevels());g=l>=o&&l<=r?l:o}else t!=a.flowType().LEFT_TOP&&t!=a.flowType().RIGHT_BOTTOM||(g=W);return g}function E(e,t){var o=n.hasSideSwimLanes()?1:0,r=n.hasSideSwimLanes()?Q.getLanes().length-2:Q.getLanes().length-1,g=-1;if(t==a.flowType().START||t==a.flowType().END)g=q;else if(t==a.flowType().PROCESS||t==a.flowType().DECISION||t==a.flowType().IN_OUT)if(q>-1)g=q;else{var l=i.getLaneIndexAtPoint(e,Q.getLanes());g=l>=o&&l<=r?l:o}else t==a.flowType().LEFT_TOP?g=0:t==a.flowType().RIGHT_BOTTOM&&(g=Q.getLanes().length-1);return g}var h,m,A,R,I,C,F,_,x,b,G,U,k,B,K,Y,V,H,X,W,j,q,z=this,J=o,Q=J.getFlowDiagram().getFlowLayout(),Z=J.getCanvas(),$=new e(o);z.dragStarted=function(e){var o=Z.getBoundingClientRect(),r=Math.floor(e.clientX-o.left),g=Math.floor(e.clientY-o.top);U=new t(r,g),V=U,m=void 0;var i=M(U),s=v(U),p=c(U),T=y(U);if(i){var L=document.createElement("img");L.src=i.getIcon().getAttribute("src"),e.dataTransfer.setDragImage(L,2,6),k=i.getAttachmentPoint();var f=i.getEdgesList();i.getType()===a.portType().LINK_CNX?(C=f[0],C.setVisible(!1),R=i,I=C.getOtherSidePort(i),I.setDNDMode(a.dndMode().ORIGIN),$.setDragMode(a.dragMode().LINK_PORT)):i.getType()===a.portType().LINK_REF?(C=f[0],C.setVisible(!1),R=i,I=C.getOtherSidePort(i),I.setDNDMode(a.dndMode().ORIGIN),$.setDragMode(a.dragMode().LINK_PORT)):i.getType()===a.portType().MARKUP?(I=i,I.setVisible(!0),I.setDNDMode(a.dndMode().ORIGIN),$.setDragMode(a.dragMode().MARKUP_PORT)):i.getType()===a.portType().REF&&(I=i,I.setVisible(!0),I.setDNDMode(a.dndMode().ORIGIN),$.setDragMode(a.dragMode().REF_PORT))}else if(s){if(n.getLayoutMode()===a.layoutMode().AUTO)return e.preventDefault(),void z.resetDrag();m=s,Y=s.getFlowType(),m.showMarkupPorts(!1),m.hideRefPorts(),m.setDrawState(a.drawState().DRAGGED),A=l.getNodeFootprint(s),$.setDragMode(a.dragMode().NODE);var P=Z.cloneNode(!0);P.style.display="none",e.dataTransfer.setDragImage(P,16,16)}else if(p){var w=p.getSegmentOrder(T);if(!(w>0&&w<p.getSegments().length-1))return e.preventDefault(),void z.resetDrag();p.copySegments(),F=p,_=T,F.setDraggedOrder(w),F.setDrawMode(a.drawMode().SEGMENT_DRAGGED),G=_.getPipe(),x=new t(_.getStartPoint().x,_.getStartPoint().y),b=new t(_.getEndPoint().x,_.getEndPoint().y),$.setDragMode(a.dragMode().SEGMENT);var D=Z.cloneNode(!0);D.style.display="none",e.dataTransfer.setDragImage(D,5,5)}else e.preventDefault();d()},z.dragOver=function(e,o){var r=Z.getBoundingClientRect(),l=Math.floor(e.clientX-r.left),i=Math.floor(e.clientY-r.top);V=new t(l,i);var s;if(B=!0,K=!1,H&&H.setDragMode(a.dragMode().NONE),H=void 0,!m&&o){h||(h=g.getFlowTypeForGalleryId(o)),$.setDragMode(a.dragMode().GALLERY);var T=!1;$.canDropOnLink(o)&&(T=P(V)),n.getLayoutMode()!==a.layoutMode().MANUAL||T||u(V,h),p(V)?e.dataTransfer.dropEffect="move":e.dataTransfer.dropEffect="none",s=$.getDragOverTooltip(o)}else if(Y&&m&&A){var L=V.x-U.x,f=V.y-U.y;m.setLocationOnDrag(A.x+L,A.y+f),n.getLayoutMode()==a.layoutMode().MANUAL&&u(V,Y),s="Drag node to a new location"}else if(I)$.setAcceptedDestinations(I,V),I.setVisible(!0),R&&R.setVisible(!0),(H=$.getDragMode()===a.dragMode().LINK_PORT?$.getAcceptingPortForPoint3(I,V,C.getOtherSidePort(I)):$.getAcceptingPortForPoint2(I,V))&&H.setDragMode(a.dragMode().ACCEPT_PORT);else if(F){var v=V.x-U.x,M=V.y-U.y,c=x.x+v,y=x.y+M,w=b.x+v,D=b.y+M;_.setStartPoint(c,y),_.setEndPoint(w,D),s="Drag segment to an accepting pipe"}d(),s&&J.getCaller().setTooltipBox(s,V)},z.dragLeave=function(e){z.resetDrag(),J.getCaller().setTooltipBox(""),d()},z.dragEnd=function(e){var t=Z.getBoundingClientRect();e.dataTransfer.getData("text"),Math.floor(e.clientX-t.left),Math.floor(e.clientY-t.top);z.resetDrag(),J.refreshDiagram()},z.drop=function(e){var o=Z.getBoundingClientRect(),r=e.dataTransfer.getData("text"),l=Math.floor(e.clientX-o.left),d=Math.floor(e.clientY-o.top);h=g.getFlowTypeForGalleryId(r),a.flowType().NONE;var s=new t(l,d),p=c(s),T=z.getAcceptingCellAtPoint(s);if(!m&&h)if(p&&!p.hasSegmentShifts()&&$.canDropOnLink(r))if(n.getLayoutMode()===a.layoutMode().MANUAL){var L=i.getLevelIndexAtPoint(s,Q.getLevels()),f=i.getLaneIndexAtPoint(s,Q.getLanes()),v=i.getLevelPipeIndexAtPoint(s,Q.getLevelPipes()),M=i.getLanePipeIndexAtPoint(s,Q.getLanePipes());J.getFlowController().insertNodeOnDropOverLink(h,J.getNodeNamesMap(),p,L,f,v,M,T)}else J.getFlowController().addNodeOnDropOverLink(h,J.getNodeNamesMap(),p);else if(n.getLayoutMode()===a.layoutMode().MANUAL){if(T)J.getFlowController().addNodeOnCell(h,J.getNodeNamesMap(),T);else if(u(s,h),W>-1||q>-1){var y=S(s,h),P=E(s,h);J.getFlowController().insertNodeOnDropOnPipe(h,J.getNodeNamesMap(),y,P,W,q)}}else J.getFlowController().addNodeByType(h,J.getNodeNamesMap());else if(Y&&m&&A){if(T){var w=Q.getCellForNode(m);J.getFlowController().moveNodeToNewCell(m,w,T)}else if(u(s,m.getFlowType()),W>-1||q>-1){var D=S(s,m.getFlowType()),N=E(s,m.getFlowType());J.getFlowController().moveNodeToPipe(A,m,D,N,W,q)}}else if(I)(H=$.getDragMode()===a.dragMode().LINK_PORT?$.getAcceptingPortForPoint3(I,s,C.getOtherSidePort(I)):$.getAcceptingPortForPoint2(I,s))&&($.getDragMode()===a.dragMode().LINK_PORT&&null!=C?H===I?z.resetDrag():J.getFlowController().moveLinkPort(C,I,H):J.getFlowController().addLink(I,H));else if(F){var O;if(G.getType()===a.pipeType().LEVEL_PIPE?O=X?i.getLevelPipeAtPoint(s,Q.getLevelPipes()):void 0:G.getType()===a.pipeType().LANE_PIPE&&(O=j?i.getLanePipeAtPoint(s,Q.getLanePipes()):void 0),O&&O.getOrder()!=G.getOrder()&&$.isSegmentDropAllowed(F,_,x,b,G,O)){var R=O.getOrder()-G.getOrder();J.getFlowController().processSegmentShift(F,_.getOrder(),R)}}z.resetDrag(),J.refreshDiagram()},z.resetDrag=function(){B=!1,h=void 0,V=void 0,I=void 0,C&&(C.setVisible(!0),C=void 0),R&&(R.setVisible(!0),R=void 0),H&&H.setDragMode(a.dragMode().NONE),H=void 0,Y=void 0,m&&(m.setDrawState(a.drawState().IN_LAYOUT),A&&m.setLocationOnDrag(A.x,A.y)),F&&(F.setDrawMode(a.drawMode().SEGMENTS),F.setDraggedOrder(-1),_=void 0,F=void 0,G=void 0),m=void 0,A=void 0,X=void 0,W=-1,j=void 0,q=-1,$.clearTracking(),J.getSelectionManager().clearSelections(),J.getCaller().setTooltipBox(""),d()},z.drawAcceptingLocations=function(){var e=!1;if(n.getLayoutMode()!=a.layoutMode().MANUAL||$.getDragMode()!==a.dragMode().NODE&&$.getDragMode()!==a.dragMode().GALLERY)if(n.getLayoutMode()==a.layoutMode().MANUAL&&$.getDragMode()===a.dragMode().NONE&&n.hasEnableAddCorridors()){var t=J.getFlowDiagram().getMousePoint();if(t){O(t),X&&(T(X),e=!0),j&&(T(j),e=!0);var o=i.getLevelAtPoint(t,Q.getLevels());i.getMinLevelNumber(),i.getMaxLevelNumber(Q);L(o,a.colors().EMPTY_CORRIDOR);var r=i.getLaneAtPoint(t,Q.getLanes());i.getMinLaneNumber(),i.getMaxLaneNumber(Q);L(r,a.colors().EMPTY_CORRIDOR);var g=z.getAcceptingCellAtPoint(t);g&&(L(g,a.colors().EMPTY_CELL),e=!0)}}else $.getDragMode()===a.dragMode().SEGMENT&&(O(V),G.getType()===a.pipeType().LEVEL_PIPE?X&&X.getOrder()!==G.getOrder()&&$.isSegmentDropAllowed(F,_,x,b,G,X)&&L(X,a.colors().PIPE_DROP):G.getType()===a.pipeType().LANE_PIPE&&j&&j.getOrder()!==G.getOrder()&&$.isSegmentDropAllowed(F,_,x,b,G,j)&&L(j,a.colors().PIPE_DROP),e=!0);else{f(w(),a.colors().NODE_BGNCOLOR);var l=z.getAcceptingCellAtPoint(V);l&&T(l),!m&&h?(X&&T(X),j&&T(j)):m&&n.hasEnableAddCorridors()&&(X&&(T(X),e=!0),j&&(T(j),e=!0))}return e},z.getAcceptingCellAtPoint=function(e){var t,o;if($.getDragMode()===a.dragMode().NODE||$.getDragMode()===a.dragMode().GALLERY?t=w():$.getDragMode()===a.dragMode().NONE&&(t=D()),t)for(o=0;o<t.length;o++)if(t[o].hasPointInside(e))return t[o]}}return s});