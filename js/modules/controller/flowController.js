define("modules/controller/flowController",["modules/undo/undoHandler","modules/model/addNodeUndoableAction","modules/model/insertNodeUndoableAction","modules/model/moveNodeToCellUndoableAction","modules/model/moveNodeToPipeUndoableAction","modules/model/addLinkUndoableAction","modules/model/removeLinkUndoableAction","modules/model/removeMultipleUndoableAction","modules/model/renameNodeUndoableAction","modules/model/changeDecisionEndsUndoableAction","modules/model/modifyContentUndoableAction","modules/model/addCorridorsUndoableAction","modules/model/removeCorridorsUndoableAction","modules/model/setSegmentShiftUndoableAction","modules/model/removeSegmentShiftsUndoableAction","modules/model/changeCanvasSettingsUndoableAction","modules/layout/nodesLayoutUtils","modules/gallery/decisionEnds","modules/diagram/diagramUtils","modules/graph/graphConstants","modules/dialogs/messageDialog","modules/settings/config","modules/flow/flowUtils","modules/controller/flowCache"],function(e,t,o,n,r,i,a,d,c,g,l,s,m,u,N,p,v,f,D,S,h,U,w,C){function T(h){function w(e,o){if(e){var n=[];n.push(new t(b,e,o)),_.createUndoStack("add node "+e.name,n)}}function T(e,o){e.levelNum=o.getLevelNumber(),e.laneNum=o.getLaneNumber();var n=[];n.push(new t(b,e,o)),_.createUndoStack("add node "+e.name,n)}function O(e,o){var n=P(e,o),r=F(e,o),d=[];d.push(new a(b,o.getLinkObject())),d.push(new t(b,e,void 0)),d.push(new i(b,n)),d.push(new i(b,r)),_.createUndoStack("insert "+e.name+" to "+o.getName(),d)}function L(e,t,n,r,i){e.levelNum=t,e.laneNum=n;var a=b.getPipeXSection(t,n,r,i),d=[];d.push(new o(b,e,r,i,a)),_.createUndoStack("insert node "+e.name,d)}function I(e,t,n,r,d,c,g){e.levelNum=n>=0?n:d,e.laneNum=r>=0?r:c;var l=P(e,t),s=F(e,t),m=[];m.push(new a(b,t.getLinkObject())),m.push(new o(b,e,d,c,g)),m.push(new i(b,l)),m.push(new i(b,s)),_.createUndoStack("insert "+e.name+" into "+t.getName(),m)}function k(e){if(e===S.bValue().TRUE){var t=[];t.push(new p(b,C.isLevels(),C.levelsValue(),C.isLanes(),C.lanesValue())),_.createUndoStack("change canvas settings",t)}C.clear(),A.getCaller().setConfirmFlag(S.bValue().FALSE)}function E(e,t){if(U.hasAutoGenNodeNames()){var o=D.generateNextNodeName(t,e),n={};return n.id=S.elementType().NODE,n.name=o,n.type=D.getFlowTypeName(e),e===S.flowType().DECISION&&(n.decisionInput=f.getCurrentDecisionInput(),n.decisionEnds=f.getCurrentDecisionEnds()),n}return C.setSelectedFlowType(e),A.getCaller().setDecisionRun(void 0,S.decisionRun().CREATE),void $("#newNodeDialogId").dialog("open")}function y(e,t){if(e&&t){var o=e.getNode(),n=t.getNode();if(o&&n){var r,i,a,d,c,g,l;e.getConnector().getDirection()===S.portDirection().MARK_OUT?o.isDecisionNode()?(e.getName().indexOf(S.portNames().TRUE)>0?(c=D.getDecisionTruePortSide(o),g=o.getPortNameTrue()):e.getName().indexOf(S.portNames().FALSE)>0&&(c=D.getDecisionFalsePortSide(o),g=o.getPortNameFalse()),c&&(r=o.createOutputPort(g,c))):r=o.createOutputPort(void 0,o.getPreferredOutputSide()):e.getConnector().getDirection()===S.portDirection().MARK_IN?r=o.createInputPort(void 0,o.getPreferredInputSide()):e.getConnector().getDirection()===S.portDirection().REF_OUT?(l=e.getSide(),g=o.generateRefNextName(S.portDirection().OUT,l),r=o.createOutputPort(g,l),a=!0):e.getConnector().getDirection()===S.portDirection().REF_IN&&(l=e.getSide(),g=o.generateRefNextName(S.portDirection().IN,l),r=o.createInputPort(g,l),a=!0),t.getConnector().getDirection()===S.portDirection().MARK_OUT?n.isDecisionNode()?(t.getName().indexOf(S.portNames().TRUE)>0?(c=D.getDecisionTruePortSide(n),g=n.getPortNameTrue()):t.getName().indexOf(S.portNames().FALSE)>0&&(c=D.getDecisionFalsePortSide(n),g=n.getPortNameFalse()),c&&(i=n.createOutputPort(g,c))):i=n.createOutputPort(void 0,n.getPreferredOutputSide()):t.getConnector().getDirection()===S.portDirection().MARK_IN?i=n.createInputPort(void 0,n.getPreferredInputSide()):t.getConnector().getDirection()===S.portDirection().REF_OUT?(l=t.getSide(),g=n.generateRefNextName(S.portDirection().OUT,l),i=n.createOutputPort(g,l),d=!0):t.getConnector().getDirection()===S.portDirection().REF_IN&&(l=t.getSide(),g=n.generateRefNextName(S.portDirection().IN,l),i=n.createInputPort(g,l),d=!0);var s,m,u,N;if(e.getConnector().getDirection()===S.portDirection().OUT?(s=o.getName()+"/"+e.getName(),m=e.getSide()):e.getConnector().getDirection()===S.portDirection().MARK_OUT||e.getConnector().getDirection()===S.portDirection().REF_OUT?r&&(s=o.getName()+"/"+r.getName(),m=e.getSide()):t.getConnector().getDirection()===S.portDirection().OUT?(s=n.getName()+"/"+t.getName(),m=t.getSide()):t.getConnector().getDirection()!==S.portDirection().MARK_OUT&&t.getConnector().getDirection()!==S.portDirection().REF_OUT||i&&(s=n.getName()+"/"+i.getName(),m=t.getSide()),t.getConnector().getDirection()===S.portDirection().IN?(u=n.getName()+"/"+t.getName(),N=t.getSide()):t.getConnector().getDirection()===S.portDirection().MARK_IN||t.getConnector().getDirection()===S.portDirection().REF_IN?i&&(u=n.getName()+"/"+i.getName(),N=t.getSide()):e.getConnector().getDirection()===S.portDirection().IN?(u=o.getName()+"/"+e.getName(),N=e.getSide()):e.getConnector().getDirection()!==S.portDirection().MARK_IN&&e.getConnector().getDirection()!==S.portDirection().REF_IN||r&&(u=o.getName()+"/"+r.getName(),N=e.getSide()),s&&u){var p={};return p.id=S.elementType().EDGE,p.source=s,p.srcSide=m,p.target=u,p.trgSide=N,p.name="["+p.source+"]-["+p.target+"]",(a||d)&&(p.type=S.linkType().REF_LINK),p}}else;}}function P(e,t){var o=t.getSourcePort(),n=o.getNode(),r=n.getName()+"/"+o.getName(),i=e.type===D.getFlowTypeName(S.flowType().DECISION)?S.portNames().D_IN:"IN-0",a=e.name+"/"+i,d={};return d.id=S.elementType().EDGE,d.source=r,d.target=a,d.name="["+d.source+"]-["+d.target+"]",d.type=t.getType(),d}function F(e,t){var o=e.type===D.getFlowTypeName(S.flowType().DECISION)?S.portNames().D_TRUE:"OUT-0",n=e.name+"/"+o,r=t.getTargetPort(),i=r.getNode(),a=i.getName()+"/"+r.getName(),d={};return d.id=S.elementType().EDGE,d.source=n,d.target=a,d.name="["+d.source+"]-["+d.target+"]",d.type=t.getType(),d}var R=this,A=h,b=h.getModelHandler(),_=(b.getFlowModel(),h.getFlowDiagram().getFlowLayout(),new e(b,A.getUndoManager()));R.addNodeByType=function(e,t){var o=E(e,t);o&&w(o,void 0)},R.addNodeByName=function(e,t,o){var n={};n.name=e;var r=C.getSelectedFlowType();n.type=D.getFlowTypeName(r),t&&(n.decisionInput=t),o&&(n.decisionEnds=o);var i=C.getLink(),a=C.getCell(),d=C.isInsert(),c=C.getNodeLevel(),g=C.getNodeLane(),l=C.getPipeLevel(),s=C.getPipeLane();i&&!d?O(n,i):a?T(n,a):d&&!i?L(n,c,g,l,s):d&&i?I(n,i,c,g,l,s):w(n,a),C.clear()},R.addNodeOnCell=function(e,t,o){C.setCell(o);var n=E(e,t);n&&T(n,o)},R.addNodeOnDropOverLink=function(e,t,o){C.setLink(o);var n=E(e,t);n&&O(n,o)},R.insertNodeOnDropOnPipe=function(e,t,o,n,r,i){C.setInsert(!0),C.setNodeLevel(o),C.setNodeLane(n),C.setPipeLevel(r),C.setPipeLane(i);var a=E(e,t);a&&L(a,o,n,r,i)},R.insertNodeOnDropOverLink=function(e,t,o,n,r,i,a,d){C.setLink(o),C.setInsert(!0),C.setNodeLevel(n),C.setNodeLane(r),C.setPipeLevel(i),C.setPipeLane(a);var c=E(e,t);c&&I(c,o,n,r,i,a,d)},R.moveNodeToNewCell=function(e,t,o){var r=[];r.push(new n(b,e,t,o)),_.createUndoStack("move "+e.getName(),r)},R.moveNodeToPipe=function(e,t,o,n,i,a){var d=b.getPipeXSection(o,n,i,a),c=[];c.push(new r(b,e,t,o,n,i,a,d)),_.createUndoStack("move "+t.getName(),c)},R.renameNode=function(e,t){var o=b.getSelectionsMapForItem(e),n="rename from "+e.getName()+" to "+t,r=[];r.push(new c(b,o,n,e.getName(),t)),_.createUndoStack(n,r)},R.modifyContent=function(e,t){var o=e.getNodeObject(),n=[];n.push(new l(b,o,t)),_.createUndoStack("edit content text for "+e.getName(),n)},R.changeNodeDecisionEnds=function(e,t,o){var n=e.getNodeObject(),r=[];r.push(new g(b,n,t,o)),_.createUndoStack("change decision layout for "+e.getName(),r)},R.removeNode=function(e){var t=b.getSelectionsMapForItem(e),o=[];o.push(new d(b,t,e.getName())),_.createUndoStack("remove node "+e.getName(),o)},R.addLink=function(e,t){var o=y(e,t);if(o){var n=[];n.push(new i(b,o)),_.createUndoStack("add link "+o.name,n)}},R.removeLink=function(e){var t=e.getLinkObject(),o=[];o.push(new a(b,t)),_.createUndoStack("remove link "+t.name,o)},R.moveLinkPort=function(e,t,o){var n=y(t,o),r=[];r.push(new a(b,e.getLinkObject())),r.push(new i(b,n)),_.createUndoStack("move from "+t.getName()+" to "+o.getName(),r)},R.removeSelections=function(){var e=A.getSelectionManager().getSelections(),t=b.getSelectionObjectsMap(e),o=[],n=1==e.length?" selected item":" selected items";o.push(new d(b,t,"remove "+e.length+n)),_.createUndoStack("remove "+e.length+n,o)},R.addCorridor=function(e,t){if(-1!==e||-1!==t){var o="add ";e>-1&&t>-1?o+="level & lane":e>-1&&t<0?o+="level":e<0&&t>-1&&(o+="lane");var n=[];n.push(new s(b,e,t,o)),_.createUndoStack(o,n)}},R.removeCorridor=function(e,t){if(-1!=e||-1!=t){var o="remove ";e>-1&&t>-1?o+="level & lane":e>-1&&t<0?o+="level":e<0&&t>-1&&(o+="lane");var n=[];n.push(new m(b,e,t,o)),_.createUndoStack(o,n)}},R.processSegmentShift=function(e,t,o){var n=[];n.push(new u(b,e,t,o)),_.createUndoStack("shift segment ",n)},R.clearSegmentShifts=function(e){var t=[];t.push(new N(b,e)),_.createUndoStack("remove segment shifts",t)},R.clearAllShifts=function(){var e=b.getFlowLinks(),t=[];t.push(new N(b,e)),_.createUndoStack("remove segment shifts",t)},R.changeCanvasSettings=function(e,t,o,n){var r,i=e&&t===S.change().DOWN&&(v.getStartNodes(b.getFlowNodes()).length>0||v.getEndNodes(b.getFlowNodes()).length>0),a=o&&n===S.change().DOWN&&(v.getLeftLaneNodes(b.getFlowNodes()).length>0||v.getRightLaneNodes(b.getFlowNodes()).length>0);i&&a?r="Do you want to remove all start/end and side nodes?":i&&!a?r="Do you want to remove all start/end nodes?":!i&&a&&(r="Do you want to remove all side nodes?"),C.clear(),C.setIsLevels(e),C.setLevelsValue(t),C.setIsLanes(o),C.setLanesValue(n),r?(A.getCaller().showConfirmMessage(r,"Confirm"),$("#confirmDialogId").on("dialogclose",function(e,t){k(A.getCaller().getConfirmFlag())})):k(S.bValue().TRUE)},R.editDecisionNode=function(e){A.getCaller().setDecisionRun(e,S.decisionRun().EDIT),$("#newNodeDialogId").dialog("open")}}return T});